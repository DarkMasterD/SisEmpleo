@model SisEmpleo.Models.OfertaEmpleo


@{
    var ofertaEmp = ViewBag.Oferta as OfertaEmpleo ?? new OfertaEmpleo();
    string[] horario;
    if (ViewBag.Horario is string[] h && h.Length == 28)
    {
        horario = h;
    }
    else
    {
        horario = Enumerable.Repeat("", 28).ToArray();
    }
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workeen - Editar Oferta de Empleo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #F4F6F9;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }



        .btn-profile {
            background-color: #1E3A8A;
            border: none;
            color: #FFFFFF;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
        }

            .btn-profile:hover {
                background-color: #152A66;
            }

        .btn-logout {
            background-color: #F97316;
            border: none;
            color: #FFFFFF;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
        }

            .btn-logout:hover {
                background-color: #E86100;
            }

        .edit-container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: #FFFFFF;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

            .edit-container h2 {
                color: #1E3A8A;
                text-align: center;
                margin-bottom: 1.5rem;
                font-weight: bold;
            }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-control {
            border-radius: 5px;
            border: 1px solid #D1D5DB;
            padding: 0.75rem;
        }

            .form-control:focus {
                border-color: #1E3A8A;
                box-shadow: 0 0 5px rgba(30, 58, 138, 0.3);
            }

        .btn-primary {
            background-color: #F97316;
            border: none;
            width: 100%;
            padding: 0.75rem;
            font-weight: 600;
            border-radius: 5px;
        }

            .btn-primary:hover {
                background-color: #E86100;
            }

        .btn-secondary {
            background-color: #6B7280;
            border: none;
            width: 100%;
            padding: 0.75rem;
            font-weight: 600;
            border-radius: 5px;
        }

            .btn-secondary:hover {
                background-color: #4B5563;
            }

        .day-schedule {
            margin-bottom: 1.5rem;
        }

            .day-schedule h4 {
                color: #374151;
                margin-bottom: 0.5rem;
            }
    </style>
</head>
<body>


    <!-- Formulario de Edición -->
    <div class="edit-container">
        <h2>Editar Oferta de Empleo</h2>
        <form asp-action="EditarOferta" method="post">
            <div class="form-group">
                <label for="estado">Estado</label>
                <select name="estado" id="estado" class="form-control" required>
                    <option value="">Seleccione...</option>
                    <option value="1" selected="@(ofertaEmp.estado == true)">Activo</option>
                    <option value="0" selected="@(ofertaEmp.estado == false)">Inactivo</option>
                </select>
                <span asp-validation-for="estado" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label for="id_pais">País</label>
                @Html.DropDownList("id_pais", ViewBag.Pais as IEnumerable<SelectListItem>, "Seleccione un país", new { @class = "form-control", id = "cboPais" })
            </div>
            <div class="form-group">
                <label for="id_provincia">Provincia</label>
                @Html.DropDownList("id_provincia", ViewBag.Provincia as SelectList, "Seleccione una provincia", new { @class = "form-control", id = "cboProvincia" })
            </div>
            <div class="form-group">
                <label for="titulo">Título</label>
                @Html.TextBox("titulo", ofertaEmp.titulo, new { @class = "form-control", required = "required" })
            </div>
            <div class="form-group">
                <label for="descripcion">Descripción</label>
                @Html.TextArea("descripcion", ofertaEmp.descripcion, new { @class = "form-control", id = "direccion", rows = "4", required = "required" })
            </div>
            <div class="form-group">
                <label for="vacantes">Vacantes</label>
                @Html.TextBox("vacante", ofertaEmp.vacante, new { @class = "form-control", type = "number", step = "1", min = "0", required = "required" })
            </div>
            <div class="form-group">
                <label for="salario">Salario</label>
                @Html.TextBox("salario", ofertaEmp.salario, new { @class = "form-control", type = "number", step = "1", min = "0", required = "required" })
            </div>
            <div class="form-group">
                <label for="duracion_contrato">Duración del Contrato</label>
                @Html.TextBox("duracion_contrato", ofertaEmp.duracion_contrato, new { @class = "form-control", required = "required" })
            </div>

            <!-- Horario -->
            <h3 class="mt-4">Horario</h3>
            <div class="day-schedule">
                <h4>Lunes</h4>
                <div class="row">
                    <div class="col-6">
                        <input type="time" name="lunes1" value="@(horario.Length > 0 ? horario[0] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="lunes2" value="@(horario.Length > 1 ? horario[1] : "")" class="form-control" />
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <input type="time" name="lunes3" value="@(horario.Length > 2 ? horario[2] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="lunes4" value="@(horario.Length > 3 ? horario[3] : "")" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="day-schedule">
                <h4>Martes</h4>
                <div class="row">
                    <div class="col-6">
                        <input type="time" name="martes1" value="@(horario.Length > 0 ? horario[4] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="martes2" value="@(horario.Length > 1 ? horario[5] : "")" class="form-control" />
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <input type="time" name="martes3" value="@(horario.Length > 2 ? horario[6] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="martes4" value="@(horario.Length > 3 ? horario[7] : "")" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="day-schedule">
                <h4>Miercoles</h4>
                <div class="row">
                    <div class="col-6">
                        <input type="time" name="miercoles1" value="@(horario.Length > 0 ? horario[8] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="miercoles2" value="@(horario.Length > 1 ? horario[9] : "")" class="form-control" />
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <input type="time" name="miercoles3" value="@(horario.Length > 2 ? horario[10] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="miercoles4" value="@(horario.Length > 3 ? horario[11] : "")" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="day-schedule">
                <h4>Jueves</h4>
                <div class="row">
                    <div class="col-6">
                        <input type="time" name="jueves1" value="@(horario.Length > 0 ? horario[12] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="jueves2" value="@(horario.Length > 1 ? horario[13] : "")" class="form-control" />
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <input type="time" name="jueves3" value="@(horario.Length > 2 ? horario[14] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="jueves4" value="@(horario.Length > 3 ? horario[15] : "")" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="day-schedule">
                <h4>Viernes</h4>
                <div class="row">
                    <div class="col-6">
                        <input type="time" name="viernes1" value="@(horario.Length > 0 ? horario[16] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="viernes2" value="@(horario.Length > 1 ? horario[17] : "")" class="form-control" />
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <input type="time" name="viernes3" value="@(horario.Length > 2 ? horario[18] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="viernes4" value="@(horario.Length > 3 ? horario[19] : "")" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="day-schedule">
                <h4>Sábado</h4>
                <div class="row">
                    <div class="col-6">
                        <input type="time" name="sabado1" value="@(horario.Length > 0 ? horario[20] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="sabado2" value="@(horario.Length > 1 ? horario[21] : "")" class="form-control" />
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <input type="time" name="sabado3" value="@(horario.Length > 2 ? horario[22] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="sabado4" value="@(horario.Length > 3 ? horario[23] : "")" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="day-schedule">
                <h4>Domingo</h4>
                <div class="row">
                    <div class="col-6">
                        <input type="time" name="domingo1" value="@(horario.Length > 0 ? horario[24] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="domingo2" value="@(horario.Length > 1 ? horario[25] : "")" class="form-control" />
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <input type="time" name="domingo3" value="@(horario.Length > 2 ? horario[26] : "")" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="time" name="domingo4" value="@(horario.Length > 3 ? horario[27] : "")" class="form-control" />
                    </div>
                </div>
            </div>

            <!-- Campos ocultos -->
            <input type="hidden" id="horario" name="horario" value="@string.Join(";", horario)" />
            <input type="hidden" value="@ofertaEmp.id_ofertaempleo" name="id_ofertaempleo" />
            <input type="hidden" name="PaisNombre" value="" />
            <input type="hidden" name="EmpresaNombre" value="" />
            <input type="hidden" name="ProvinciaNombre" value="" />

            <!-- Botones -->
            <div class="row mt-4">
                <div class="col-6">
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
                <div class="col-6">
                    <a href="/Home/Index" class="btn btn-secondary">Cancelar</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            console.log("jQuery cargado");

            // Solo se usará al inicio para seleccionar la provincia original
            var provinciaInicial = '@(ofertaEmp?.id_provincia ?? 0)';
            var paisInicial = '@(ofertaEmp?.id_pais ?? 0)';
            var primerCarga = true;

            function cargarProvincias(idPais) {
                if (!idPais) {
                    $('#cboProvincia').html('<option value="">Seleccione un país primero</option>');
                    return;
                }

                $('#cboProvincia').html('<option value="">Cargando provincias...</option>');

                $.ajax({
                    url: '/OfertaEmpleoEmpresa/ObtenerProvincia',
                    type: 'GET',
                    data: { id_pais: idPais },
                    dataType: 'json',
                    success: function (data) {
                        if (data && data.length > 0) {
                            var options = '<option value="">Seleccione una provincia</option>';
                            $.each(data, function (index, provincia) {
                                options += '<option value="' + provincia.id_provincia + '">' + provincia.nombre + '</option>';
                            });
                            $('#cboProvincia').html(options);

                            if (primerCarga && idPais == paisInicial) {
                                $('#cboProvincia').val(provinciaInicial);
                            }

                            primerCarga = false;
                        } else {
                            $('#cboProvincia').html('<option value="">No hay provincias para este país</option>');
                        }
                    },
                    error: function () {
                        $('#cboProvincia').html('<option value="">Error al cargar provincias</option>');
                    }
                });
            }

            // Evento de cambio en país
            $('#cboPais').change(function () {
                var idPais = $(this).val();
                cargarProvincias(idPais);
            });

            // Primera carga si hay país preseleccionado
            if ($('#cboPais').val()) {
                cargarProvincias($('#cboPais').val());
            }

            // Manejo del envío del formulario
            $('form').on('submit', function (e) {
                let hasErrors = false;

                $('[required]').each(function () {
                    const $field = $(this);
                    const fieldValue = $field.val();

                    if (!fieldValue) {
                        markFieldAsInvalid($field, 'Este campo es requerido');
                        hasErrors = true;
                    } else {
                        markFieldAsValid($field);
                    }
                });

                // Validación específica del estado (1/0)
                const $estadoField = $('[name="estado"]');
                const estadoValue = $estadoField.val();

                if (estadoValue !== "1" && estadoValue !== "0") {
                    markFieldAsInvalid($estadoField, 'Seleccione un estado válido');
                    hasErrors = true;
                } else {
                    markFieldAsValid($estadoField);
                    // NO modificar el valor (dejar como "1" o "0")
                }

                if (hasErrors) {
                    e.preventDefault();
                    scrollToFirstError();
                    return;
                }

                buildHorarioString();
            });

            function buildHorarioString() {
                const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
                const timeSlots = [];

                days.forEach(day => {
                    for (let i = 1; i <= 4; i++) {
                        const timeValue = $(`[name="${day}${i}"]`).val() || '';
                        timeSlots.push(timeValue);
                    }
                });

                while (timeSlots.length < 28) {
                    timeSlots.push('');
                }

                $('#horario').val(timeSlots.join(';'));
                console.log('Horario a enviar:', $('#horario').val());
            }

            // Función para marcar campo como inválido
            function markFieldAsInvalid($field, message) {
                $field.addClass('is-invalid');
                if ($field.next('.field-error').length === 0) {
                    $field.after(`<span class="text-danger field-error">${message}</span>`);
                }
            }

            // Función para marcar campo como válido
            function markFieldAsValid($field) {
                $field.removeClass('is-invalid');
                $field.next('.field-error').remove();
            }

            // Función para desplazarse al primer error
            function scrollToFirstError() {
                const $firstError = $('.is-invalid').first();
                if ($firstError.length) {
                    $('html, body').animate({
                        scrollTop: $firstError.offset().top - 100
                    }, 500);
                }
            }

            // Validación en tiempo real para campos requeridos
            $('[required]').on('blur change', function () {
                const $field = $(this);
                if (!$field.val()) {
                    markFieldAsInvalid($field, 'Este campo es requerido');
                } else {
                    markFieldAsValid($field);
                }
            });

            // Validación especial para el campo estado
            $('[name="estado"]').on('change', function () {
                const value = $(this).val();
                if (value === "1" || value === "0") {
                    markFieldAsValid($(this));
                } else {
                    markFieldAsInvalid($(this), 'Seleccione un estado válido');
                }
            });
        });
    </script>





</body>
</html>