@model SisEmpleo.Models.Viewmodels.EditarPerfilViewModel

@{
    ViewData["Title"] = "Editar Mi Perfil";
}

<div class="container my-5">
    <h2 class="mb-4 text-primary fw-bold">@ViewData["Title"]</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">@TempData["SuccessMessage"]<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">@Html.Raw(TempData["ErrorMessage"].ToString().Replace("\n", "<br />"))<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    }
    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show">@TempData["InfoMessage"]<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    }

    @* --- FORMULARIO PRINCIPAL PARA DATOS PERSONALES, UBICACIÓN E IDIOMA PRINCIPAL --- *@
    <form asp-action="EditarPerfil" method="post" novalidate id="formPrincipalEditarPerfil">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <div class="card shadow-sm mb-4">
            <div class="card-header"><h5 class="mb-0">Información Personal y de Contacto</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="Nombre" class="form-label fw-semibold"></label>
                        <input asp-for="Nombre" class="form-control" />
                        <span asp-validation-for="Nombre" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Apellidos" class="form-label fw-semibold"></label>
                        <input asp-for="Apellidos" class="form-control" />
                        <span asp-validation-for="Apellidos" class="text-danger"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="Email" class="form-label fw-semibold"></label>
                        <input asp-for="Email" type="email" class="form-control" readonly />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Telefono" class="form-label fw-semibold"></label>
                        <input asp-for="Telefono" class="form-control" placeholder="Opcional" />
                        <span asp-validation-for="Telefono" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="EmailContacto" class="form-label fw-semibold"></label>
                        <input asp-for="EmailContacto" type="email" class="form-control" placeholder="Opcional" />
                        <span asp-validation-for="EmailContacto" class="text-danger"></span>


                    </div>
                    <div class="col-md-6">
                        <label asp-for="Fecha_Nacimiento" class="form-label fw-semibold"></label>
                        <input asp-for="Fecha_Nacimiento" type="date" class="form-control" />
                        <span asp-validation-for="Fecha_Nacimiento" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header"><h5 class="mb-0">Ubicación e Idioma Principal</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="PaisId" class="form-label fw-semibold"></label>
                        <select asp-for="PaisId" asp-items="Model.Paises" class="form-select" id="selectPaisResidencia">
                            <option value="">Seleccione un país</option>
                        </select>
                        <span asp-validation-for="PaisId" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="ProvinciaId" class="form-label fw-semibold"></label>
                        <select asp-for="ProvinciaId" asp-items="Model.Provincias" class="form-select" id="selectProvinciaResidencia">
                            <option value="">Seleccione una provincia</option>
                        </select>
                        <span asp-validation-for="ProvinciaId" class="text-danger"></span>
                    </div>
                    <div class="col-md-12">
                        <label asp-for="PrimaryIdiomaId" class="form-label fw-semibold"></label>
                        <select asp-for="PrimaryIdiomaId" asp-items="Model.IdiomasPrincipalesDisponibles" class="form-select">
                            <option value="">Seleccione su idioma principal</option>
                        </select>
                        <span asp-validation-for="PrimaryIdiomaId" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 text-center mt-3 mb-5">
                <button type="submit" class="btn btn-primary btn-lg px-5 shadow-sm">
                    <i class="bi bi-save me-2"></i> Guardar Cambios Principales
                </button>
            </div>
        </div>
    </form> @* FIN DEL FORMULARIO PRINCIPAL *@

    <hr class="my-5">

    @* --- SECCIÓN PARA GESTIONAR HABILIDADES --- *@
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5 class="mb-0">Mis Habilidades</h5></div>
        <div class="card-body">
            @if (Model.HabilidadesActuales.Any())
            {
                <h6 class="mb-3 text-muted">Habilidades Guardadas:</h6>
                <ul class="list-group list-group-flush mb-3">
                    @foreach (var habilidadCv in Model.HabilidadesActuales)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                            @habilidadCv.NombreHabilidad
                            <form asp-action="EliminarHabilidadCv" asp-controller="Perfil" method="post" class="ms-2">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="idHabilidadCurriculum" value="@habilidadCv.IdHabilidadCurriculum" />
                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar @habilidadCv.NombreHabilidad">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p class="text-muted fst-italic">Aún no has agregado habilidades a tu perfil.</p>
            }

            <h6 class="mt-4 pt-3 border-top">Añadir Nueva Habilidad:</h6>
            <form asp-action="AnadirHabilidadCv" asp-controller="Perfil" method="post" class="row g-2 align-items-end">
                @Html.AntiForgeryToken()
                <div class="col">
                    <label asp-for="IdHabilidadSeleccionadaParaAnadir" class="form-label visually-hidden">Habilidad</label>
                    <select asp-for="IdHabilidadSeleccionadaParaAnadir" asp-items="Model.HabilidadesDisponiblesParaAnadir" class="form-select">
                        <option value="">Seleccione habilidad...</option>
                    </select>
                    <span asp-validation-for="IdHabilidadSeleccionadaParaAnadir" class="text-danger"></span>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle me-1"></i> Añadir
                    </button>
                </div>
            </form>
        </div>
    </div>

    @* --- SECCIÓN PARA GESTIONAR "OTROS IDIOMAS" (con institución y fecha) --- *@
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5 class="mb-0">Otros Idiomas (Certificados/Estudiados)</h5></div>
        <div class="card-body">
            @if (Model.OtrosIdiomasActuales.Any())
            {
                <h6 class="mb-3 text-muted">Idiomas Guardados en CV:</h6>
                <ul class="list-group list-group-flush mb-3">
                    @foreach (var idiomaCv in Model.OtrosIdiomasActuales)
                    {
                        <li class="list-group-item ps-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>@idiomaCv.NombreIdioma</strong><br />
                                    <small class="text-muted">Institución: @idiomaCv.NombreInstitucion</small><br />
                                    <small class="text-muted">Fecha: @idiomaCv.FechaObtencionFormateada</small>
                                </div>
                                <form asp-action="EliminarOtroIdiomaCv" asp-controller="Perfil" method="post" class="ms-2">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="idIdiomaCurriculum" value="@idiomaCv.IdIdiomaCurriculum" />
                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar @idiomaCv.NombreIdioma del CV">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p class="text-muted fst-italic">Aún no has agregado otros idiomas a tu CV.</p>
            }

            <form asp-action="AnadirOtroIdiomaCv" asp-controller="Perfil" method="post" class="row g-3 align-items-start">
                @Html.AntiForgeryToken()
                @* Los campos deben bindear a Model.NuevoOtroIdioma.*@
                <div class="col-md-4">
                    <label asp-for="NuevoOtroIdioma.IdiomaId" class="form-label">Idioma</label>
                    <select asp-for="NuevoOtroIdioma.IdiomaId" asp-items="Model.TodosLosIdiomasDisponibles" class="form-select">
                        <option value="">Seleccione idioma...</option>
                    </select>
                    <span asp-validation-for="NuevoOtroIdioma.IdiomaId" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="NuevoOtroIdioma.InstitucionId" class="form-label">Institución donde lo aprendió/certificó</label>
                    <select asp-for="NuevoOtroIdioma.InstitucionId" asp-items="Model.InstitucionesRegistradasPorUsuario" class="form-select">
                        <option value="">Seleccione institución...</option>
                    </select>
                    <span asp-validation-for="NuevoOtroIdioma.InstitucionId" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="NuevoOtroIdioma.FechaObtencion" class="form-label">Fecha Obtención/Cert.</label>
                    <input asp-for="NuevoOtroIdioma.FechaObtencion" type="date" class="form-control" />
                    <span asp-validation-for="NuevoOtroIdioma.FechaObtencion" class="text-danger"></span>
                </div>
                <div class="col-md-1 align-self-end text-end">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle me-1"></i> Añadir
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            function actualizarProvincias(selectPaisElement, selectProvinciaElementId, idProvinciaPreseleccionada) {
                var idPaisSeleccionado = $(selectPaisElement).val();
                var $selectProvincia = $('#' + selectProvinciaElementId);
                $selectProvincia.empty().append('<option value="">Cargando...</option>');
                if (idPaisSeleccionado && idPaisSeleccionado !== "") {
                    $.getJSON('@Url.Action("GetProvinciasPorPais", "Perfil")', { id_pais: idPaisSeleccionado }, function (data) {
                        $selectProvincia.empty().append('<option value="">Seleccione una provincia</option>');
                        if (data && data.length > 0) {
                            $.each(data, function (index, provincia) {
                                var option = $('<option></option>').val(provincia.id_provincia).text(provincia.nombre);
                                if (provincia.id_provincia == idProvinciaPreseleccionada) {
                                    option.prop('selected', true);
                                }
                                $selectProvincia.append(option);
                            });
                        } else { $selectProvincia.append('<option value="">No hay provincias</option>'); }
                    }).fail(function () { $selectProvincia.empty().append('<option value="">Error al cargar</option>'); });
                } else { $selectProvincia.empty().append('<option value="">Seleccione país</option>'); }
            }
            $('#selectPaisResidencia').on('change', function () { actualizarProvincias(this, 'selectProvinciaResidencia', null); });
            var paisResidenciaInicial = "@Model.PaisId";
            var provinciaResidenciaSeleccionadaId = "@Model.ProvinciaId";
            if (paisResidenciaInicial && paisResidenciaInicial !== "0") {
                 $('#selectPaisResidencia').val(paisResidenciaInicial);
                actualizarProvincias('#selectPaisResidencia', 'selectProvinciaResidencia', provinciaResidenciaSeleccionadaId);
            }
        });
    </script>
}